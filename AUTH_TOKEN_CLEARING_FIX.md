# Исправление проблемы с очисткой токена при перезагрузке

## Проблема

При перезагрузке страницы происходила следующая последовательность:

1. **Инициализация authStore** - токен загружался из localStorage
2. **Попытка загрузки пользователя** - запрос к API превышал таймаут
3. **Дублирующие вызовы fetchUser()** - в разных местах вызывался `fetchUser()` без параметра `silent`
4. **Очистка токена** - при ошибке токен удалялся из localStorage
5. **Перенаправление на главную** - пользователь терял авторизацию

## Анализ логов

```
authStore: инициализация - токен найден, загружаем пользователя
Ошибка загрузки пользователя: Error: Запрос был отменен или превышено время ожидания
authStore: не удалось загрузить пользователя, но токен сохранен
Неуспешный ответ при загрузке пользователя: Object { success: undefined, message: undefined, data: undefined }
Router guard: требуется аутентификация, перенаправляем на главную
```

**Анализ:**
- Первый вызов `fetchUser(true)` (silent) - токен сохранен ✅
- Второй вызов `fetchUser()` (без silent) - токен очищен ❌

## Найденные проблемы

### 1. AppProvider.vue - дублирующая инициализация
```typescript
// ПРОБЛЕМА: Дублирует логику инициализации
onMounted(async () => {
  if (authStore.token) {
    await authStore.fetchUser() // БЕЗ silent!
  }
})
```

### 2. Router guards - повторные вызовы
```typescript
// ПРОБЛЕМА: Вызывал fetchUser без silent
const success = await authStore.fetchUser() // БЕЗ silent!
```

### 3. Composable useAuth - неправильный параметр
```typescript
// ПРОБЛЕМА: Вызывал fetchUser без silent
return await authStore.fetchUser() // БЕЗ silent!
```

### 4. ProfilePage - дублирующая загрузка
```typescript
// ПРОБЛЕМА: Вызывал fetchUser без silent
await authStore.fetchUser() // БЕЗ silent!
```

## Решение

### 1. Удаление дублирующей инициализации в AppProvider
```typescript
// ДО:
onMounted(async () => {
  if (authStore.token) {
    await authStore.fetchUser() // Очищал токен при ошибке
  }
})

// ПОСЛЕ:
onMounted(async () => {
  // Инициализация authStore уже происходит автоматически
  // Не нужно дублировать логику здесь
  console.log('AppProvider: приложение загружено')
})
```

### 2. Исправление router guards
```typescript
// ДО:
const success = await authStore.fetchUser() // Очищал токен

// ПОСЛЕ:
const success = await authStore.fetchUser(true) // silent = true
```

### 3. Исправление composable useAuth
```typescript
// ДО:
return await authStore.fetchUser() // Очищал токен

// ПОСЛЕ:
return await authStore.fetchUser(true) // silent = true
```

### 4. Исправление ProfilePage
```typescript
// ДО:
await authStore.fetchUser() // Очищал токен

// ПОСЛЕ:
await authStore.fetchUser(true) // silent = true
```

## Логика работы fetchUser

### С параметром `silent = true`:
- ✅ Не очищает токен при сетевых ошибках
- ✅ Не очищает токен при таймаутах
- ✅ Сохраняет авторизацию при проблемах с сетью
- ✅ Логирует предупреждения, но не ошибки

### Без параметра `silent` (по умолчанию `false`):
- ❌ Очищает токен при любых ошибках
- ❌ Приводит к потере авторизации
- ❌ Перенаправляет на страницу входа

## Правила использования fetchUser

### Используйте `fetchUser(true)` (silent) когда:
- ✅ Инициализация приложения
- ✅ Проверка в router guards
- ✅ Обновление данных пользователя
- ✅ Любые фоновые операции

### Используйте `fetchUser()` (без silent) только когда:
- ❌ Явный выход из системы
- ❌ Принудительная проверка токена
- ❌ Обработка ошибок авторизации

## Результат

Теперь при перезагрузке страницы:

1. ✅ **Токен сохраняется** в localStorage
2. ✅ **Инициализация происходит** без дублирования
3. ✅ **Сетевые ошибки не очищают** токен
4. ✅ **Пользователь остается авторизованным** при проблемах с сетью
5. ✅ **Единая точка инициализации** в authStore

## Проверка исправления

После исправления логи должны выглядеть так:

```
authStore: инициализация - токен найден, загружаем пользователя
Ошибка загрузки пользователя: Error: Запрос был отменен или превышено время ожидания
authStore: не удалось загрузить пользователя, но токен сохранен
Router guard: авторизованы, но нет данных пользователя, пытаемся загрузить
Router guard: не удалось загрузить пользователя
Router guard: переход на /dashboard
```

**Ключевые изменения:**
- Нет сообщения "Неуспешный ответ при загрузке пользователя"
- Нет перенаправления на главную страницу
- Пользователь остается на защищенной странице
